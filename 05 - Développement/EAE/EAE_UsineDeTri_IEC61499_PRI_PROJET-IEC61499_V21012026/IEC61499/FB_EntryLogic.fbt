<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE FBType SYSTEM "../LibraryElement.dtd">
<FBType GUID="35dab268-1d99-488a-a3f8-592a731d477c" Name="FB_EntryLogic" Comment="Logique convoyeur entree - SIMPLIFIE v2" Namespace="Main">
  <Identification Standard="61499-2" />
  <VersionInfo Organization="Schneider Electric" Version="1.1" Author="Claude" Date="20/01/2026" Remarks="Fix: convoyeur continue meme si bloque" />
  <InterfaceList>
    <EventInputs>
      <Event Name="INIT" Comment="Initialization Request">
        <With Var="QI" />
      </Event>
      <Event Name="REQ" Comment="Normal Execution Request">
        <With Var="QI" />
        <With Var="Auto" />
        <With Var="Start" />
        <With Var="Stop" />
        <With Var="AU" />
        <With Var="Reset" />
        <With Var="Presence_sensor" />
      </Event>
      <Event Name="BLOCK" Comment="Bloquer entree" />
      <Event Name="UNBLOCK" Comment="Debloquer entree" />
    </EventInputs>
    <EventOutputs>
      <Event Name="INITO" Comment="Initialization Confirm">
        <With Var="QO" />
      </Event>
      <Event Name="CNF" Comment="Execution Confirmation">
        <With Var="QO" />
        <With Var="Stop_blade" />
        <With Var="Start_light" />
        <With Var="Reset_light" />
        <With Var="Stop_light" />
        <With Var="Entry_conveyor" />
      </Event>
      <Event Name="PIECE_PRESENTE" Comment="Nouvelle piece detectee" />
      <Event Name="AU_OUT" Comment="Arret urgence active">
        <With Var="AU_Signal" />
      </Event>
      <Event Name="RESET_OUT" Comment="Reset demande">
        <With Var="Reset_Signal" />
      </Event>
    </EventOutputs>
    <InputVars>
      <VarDeclaration Name="QI" Type="BOOL" Comment="Input event qualifier" />
      <VarDeclaration Name="Auto" Type="BOOL" />
      <VarDeclaration Name="Start" Type="BOOL" />
      <VarDeclaration Name="Stop" Type="BOOL" />
      <VarDeclaration Name="AU" Type="BOOL" />
      <VarDeclaration Name="Reset" Type="BOOL" />
      <VarDeclaration Name="Presence_sensor" Type="BOOL" />
    </InputVars>
    <OutputVars>
      <VarDeclaration Name="QO" Type="BOOL" Comment="Output event qualifier" />
      <VarDeclaration Name="Stop_blade" Type="BOOL" />
      <VarDeclaration Name="Start_light" Type="BOOL" />
      <VarDeclaration Name="Reset_light" Type="BOOL" />
      <VarDeclaration Name="Stop_light" Type="BOOL" />
      <VarDeclaration Name="Entry_conveyor" Type="BOOL" />
      <VarDeclaration Name="AU_Signal" Type="BOOL" Comment="Signal AU pour autres blocs" />
      <VarDeclaration Name="Reset_Signal" Type="BOOL" Comment="Signal Reset pour autres blocs" />
    </OutputVars>
  </InterfaceList>
  <BasicFB>
    <Attribute Name="FBType.Basic.Algorithm.Order" Value="ACT_INIT,ACT_RUN,ACT_BLOCKED,ACT_UNBLOCK,ACT_AU,ACT_RESET,ACT_STOPPED" />
    <InternalVars>
      <VarDeclaration Name="Presence_prev" Type="BOOL" Comment="Etat precedent capteur" />
      <VarDeclaration Name="Blocked" Type="BOOL" Comment="Entree bloquee" />
    </InternalVars>
    <ECC>
      <ECState Name="START" Comment="Initial State" x="196" y="204" />
      <ECState Name="INIT" Comment="Initialization" x="600" y="200">
        <ECAction Algorithm="ACT_INIT" Output="INITO" />
      </ECState>
      <ECState Name="RUNNINGG" Comment="Convoyeur en marche" x="1232" y="1076">
        <ECAction Algorithm="ACT_RUN" Output="CNF" />
      </ECState>
      <ECState Name="DETECT" Comment="Piece detectee" x="2584" y="1060">
        <ECAction Output="PIECE_PRESENTE" />
      </ECState>
      <ECState Name="BLOCKED" Comment="Entree bloquee - convoyeur continue" x="1512" y="1836">
        <ECAction Algorithm="ACT_BLOCKED" Output="CNF" />
      </ECState>
      <ECState Name="UNBLOCKING" Comment="Deblocage" x="2616" y="1388">
        <ECAction Algorithm="ACT_UNBLOCK" Output="CNF" />
      </ECState>
      <ECState Name="AU_STATE" Comment="Arret urgence" x="748" y="1744">
        <ECAction Algorithm="ACT_AU" Output="CNF" />
        <ECAction Output="AU_OUT" />
      </ECState>
      <ECState Name="RESET_STATE" Comment="Reset" x="232" y="560">
        <ECAction Algorithm="ACT_RESET" Output="CNF" />
        <ECAction Output="RESET_OUT" />
      </ECState>
      <ECState Name="STOPPEDD" Comment="Arrete" x="1956" y="436">
        <ECAction Algorithm="ACT_STOPPED" Output="CNF" />
      </ECState>
      <ECTransition Source="START" Destination="INIT" Condition="INIT" x="415.6831" y="113.8155">
        <Attribute Name="Configuration.Transaction.BezierPoints" Value="97.20443,25.52796,112.0566,25.37943" />
      </ECTransition>
      <ECTransition Source="INIT" Destination="RUNNINGG" Condition="REQ AND Auto AND Start AND Stop AND NOT AU" x="966.9125" y="585.5679">
        <Attribute Name="Configuration.Transaction.BezierPoints" Value="220.5584,109.6505,268.1139,174.3948" />
      </ECTransition>
      <ECTransition Source="RUNNINGG" Destination="DETECT" Condition="REQ AND Presence_sensor " x="1926.66" y="997.0787">
        <Attribute Name="Configuration.Transaction.BezierPoints" Value="439.2788,246.2181,523.9513,245.1236" />
      </ECTransition>
      <ECTransition Source="DETECT" Destination="RUNNINGG" Condition="1" x="1927.6" y="1140.29">
        <Attribute Name="Configuration.Transaction.BezierPoints" Value="524.2677,288.2348,439.5896,289.1083" />
      </ECTransition>
      <ECTransition Source="RUNNINGG" Destination="BLOCKED" Condition="BLOCK" x="1451.514" y="1438.957">
        <Attribute Name="Configuration.Transaction.BezierPoints" Value="357.9721,330.929,377.5824,385.7089" />
      </ECTransition>
      <ECTransition Source="BLOCKED" Destination="UNBLOCKING" Condition="UNBLOCK AND NOT AU" x="2020.807" y="1539.771">
        <Attribute Name="Configuration.Transaction.BezierPoints" Value="474.4788,393.3456,540.5142,365.8472" />
      </ECTransition>
      <ECTransition Source="UNBLOCKING" Destination="RUNNINGG" Condition="1" x="1972.277" y="1315.491">
        <Attribute Name="Configuration.Transaction.BezierPoints" Value="545.1193,343.3097,455.7984,324.5719" />
      </ECTransition>
      <ECTransition Source="RUNNINGG" Destination="AU_STATE" Condition="AU" x="1039.819" y="1464.721">
        <Attribute Name="Configuration.Transaction.BezierPoints" Value="279.4557,347.3372,244.3221,394.1434" />
      </ECTransition>
      <ECTransition Source="BLOCKED" Destination="AU_STATE" Condition="AU" x="1148.973" y="1884.419">
        <Attribute Name="Configuration.Transaction.BezierPoints" Value="309.8121,477.0533,271.8271,472.8409" />
      </ECTransition>
      <ECTransition Source="AU_STATE" Destination="RESET_STATE" Condition="Reset AND NOT AU" x="414.1457" y="1021.397">
        <Attribute Name="Configuration.Transaction.BezierPoints" Value="117.0887,289.649,77.92796,199.2823" />
      </ECTransition>
      <ECTransition Source="RESET_STATE" Destination="INIT" Condition="1" x="408.3135" y="301.5512">
        <Attribute Name="Configuration.Transaction.BezierPoints" Value="93.11182,80.65147,114.8882,59.34853" />
      </ECTransition>
      <ECTransition Source="RUNNINGG" Destination="STOPPEDD" Condition="NOT Stop" x="1655.582" y="643.5662">
        <Attribute Name="Configuration.Transaction.BezierPoints" Value="393.2161,174.6132,449.6726,128.4309" />
      </ECTransition>
      <ECTransition Source="STOPPEDD" Destination="RUNNINGG" Condition="REQ AND Start AND Stop AND NOT AU" x="1597.391" y="837.4059">
        <Attribute Name="Configuration.Transaction.BezierPoints" Value="424.3997,193.0377,369.0836,239.2329" />
      </ECTransition>
      <ECTransition Source="STOPPEDD" Destination="AU_STATE" Condition="AU" x="1393.32" y="1150.809">
        <Attribute Name="Configuration.Transaction.BezierPoints" Value="397.5701,242.313,303.5849,343.2262" />
      </ECTransition>
      <ECTransition Source="INIT" Destination="AU_STATE" Condition="AU" x="746.0094" y="976.348">
        <Attribute Name="Configuration.Transaction.BezierPoints" Value="186.147,184.3086,197.316,304.5901" />
      </ECTransition>
    </ECC>
    <Algorithm Name="ACT_INIT" Comment="Initialization">
      <ST><![CDATA[QO := TRUE;
Entry_conveyor := FALSE;
Stop_blade := FALSE;
Start_light := FALSE;
Reset_light := TRUE;
Stop_light := FALSE;
Presence_prev := FALSE;
Blocked := FALSE;
AU_Signal := FALSE;
Reset_Signal := FALSE;]]></ST>
    </Algorithm>
    <Algorithm Name="ACT_RUN" Comment="Convoyeur en marche">
      <ST><![CDATA[(* Convoyeur TOUJOURS en marche *)
Entry_conveyor := TRUE;
Stop_blade := FALSE;
Start_light := TRUE;
Reset_light := FALSE;
Stop_light := FALSE;
Presence_prev := Presence_sensor;]]></ST>
    </Algorithm>
    <Algorithm Name="ACT_BLOCKED" Comment="Entree bloquee">
      <ST><![CDATA[(* Bloquer entree - piece en cours deja sur exit conveyor *)
Blocked := TRUE;
Entry_conveyor := FALSE;  (* Arreter convoyeur entree *)
Stop_blade := TRUE;       (* Lame levee *)
Start_light := TRUE;
Reset_light := FALSE;
Stop_light := FALSE;
Presence_prev := Presence_sensor;]]></ST>
    </Algorithm>
    <Algorithm Name="ACT_UNBLOCK" Comment="Debloquer entree">
      <ST><![CDATA[(* Debloquer - baisser la lame *)
Blocked := FALSE;
Entry_conveyor := TRUE;
Stop_blade := FALSE;
Start_light := TRUE;
Reset_light := FALSE;
Stop_light := FALSE;
Presence_prev := Presence_sensor;]]></ST>
    </Algorithm>
    <Algorithm Name="ACT_AU" Comment="Arret urgence">
      <ST><![CDATA[(* Tout arreter immediatement *)
AU_Signal := TRUE;
Reset_Signal := FALSE;
Blocked := FALSE;
Entry_conveyor := FALSE;
Stop_blade := TRUE;
Start_light := FALSE;
Reset_light := TRUE;
Stop_light := TRUE;
Presence_prev := FALSE;]]></ST>
    </Algorithm>
    <Algorithm Name="ACT_RESET" Comment="Reset">
      <ST><![CDATA[(* Remettre a zero *)
AU_Signal := FALSE;
Reset_Signal := TRUE;
Blocked := FALSE;
Entry_conveyor := FALSE;
Stop_blade := FALSE;
Start_light := FALSE;
Reset_light := TRUE;
Stop_light := FALSE;
Presence_prev := FALSE;]]></ST>
    </Algorithm>
    <Algorithm Name="ACT_STOPPED" Comment="Arrete proprement">
      <ST><![CDATA[(* Usine arretee *)
Blocked := FALSE;
Entry_conveyor := FALSE;
Stop_blade := FALSE;
Start_light := FALSE;
Reset_light := FALSE;
Stop_light := TRUE;
Presence_prev := FALSE;]]></ST>
    </Algorithm>
  </BasicFB>
</FBType>